function module(e,t,a){let n,s,i,r,l,o,g,c,m,h,d,p,u;a.link("meteor/meteor",{Meteor(e){n=e}},0),a.link("meteor/reactive-var",{ReactiveVar(e){s=e}},1),a.link("meteor/kadira:flow-router",{FlowRouter(e){i=e}},2),a.link("meteor/templating",{Template(e){r=e}},3),a.link("underscore",{default(e){l=e}},4),a.link("toastr",{default(e){o=e}},5),a.link("../../../../ui-utils",{TabBar(e){g=e},RocketChatTabBar(e){c=e}},6),a.link("../../../../utils",{t(e){m=e},handleError(e){h=e}},7),a.link("../../../../authorization",{hasPermission(e){d=e}},8),a.link("./customTemplates/register",{getCustomFormTemplate(e){p=e}},9),a.link("./livechatDepartmentForm.html"),a.link("../../../../utils/client",{APIClient(e){u=e}},10),r.livechatDepartmentForm.helpers({department:()=>r.instance().department.get(),agents:()=>r.instance().department&&!l.isEmpty(r.instance().department.get())?r.instance().department.get().agents:[],departmentAgents:()=>l.sortBy(r.instance().departmentAgents.get(),"username"),showOnRegistration(e){const t=r.instance().department.get();return t.showOnRegistration===e||void 0===t.showOnRegistration&&!0===e},showOnOfflineForm(e){const t=r.instance().department.get();return t.showOnOfflineForm===e||void 0===t.showOnOfflineForm&&!0===e},requestTagBeforeClosingChat(){const e=r.instance().department.get();return!(!e||!e.requestTagBeforeClosingChat)},customFieldsTemplate:()=>p("livechatDepartmentForm"),data:()=>({id:i.getParam("_id")}),exceptionsAgents:()=>l.pluck(r.instance().departmentAgents.get(),"username"),agentModifier:()=>(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const a=e.get();return"@".concat(0===a.length?t:t.replace(new RegExp(e.get()),e=>"<strong>".concat(e,"</strong>")))}),agentConditions:()=>({roles:"livechat-agent"}),onSelectAgents:()=>r.instance().onSelectAgents,selectedAgents:()=>r.instance().selectedAgents.get(),onClickTagAgents:()=>r.instance().onClickTagAgents,flexData:()=>({tabBar:r.instance().tabBar,data:r.instance().tabBarData.get()}),tabBarVisible:()=>Object.values(g.buttons.get()).some(e=>e.groups.some(e=>e.startsWith("livechat-department"))),chatClosingTags:()=>r.instance().chatClosingTags.get(),availableDepartmentTags:()=>r.instance().availableDepartmentTags.get(),hasAvailableTags:()=>[...r.instance().availableTags.get()].length>0,hasChatClosingTags:()=>[...r.instance().chatClosingTags.get()].length>0}),r.livechatDepartmentForm.events({"submit #department-form"(e,t){e.preventDefault();const a=t.$("button.save");let s;const r=$(e.currentTarget).data("id");if(d("manage-livechat-departments")){const e=t.$("input[name=enabled]:checked").val(),a=t.$("input[name=name]").val(),n=t.$("textarea[name=description]").val(),i=t.$("input[name=showOnRegistration]:checked").val(),r=t.$("input[name=email]").val(),l=t.$("input[name=showOnOfflineForm]:checked").val(),g=t.$("input[name=requestTagBeforeClosingChat]:checked").val(),c=t.chatClosingTags.get();if("1"!==e&&"0"!==e)return o.error(m("Please_select_enabled_yes_or_no"));if(""===a.trim())return o.error(m("Please_fill_a_name"));if(""===r.trim()&&"1"===l)return o.error(m("Please_fill_an_email"));s={enabled:"1"===e,name:a.trim(),description:n.trim(),showOnRegistration:"1"===i,showOnOfflineForm:"1"===l,requestTagBeforeClosingChat:"1"===g,email:r.trim(),chatClosingTags:c}}const l=a.html();a.html(m("Saving")),t.$(".customFormField").each((e,a)=>{const n=t.$(a),i=n.attr("name");s[i]=n.val()});const g=[];t.departmentAgents.get().forEach(e=>{e.count=t.$(".count-".concat(e.agentId)).val(),e.order=t.$(".order-".concat(e.agentId)).val(),g.push(e)});const c=e=>{if(a.html(l),e)return h(e);o.success(m("Saved")),i.go("livechat-departments")};if(d("manage-livechat-departments"))n.call("livechat:saveDepartment",r,s,g,c);else{if(!d("add-livechat-department-agents"))throw new Error(m("error-not-authorized"));n.call("livechat:saveDepartmentAgents",r,g,c)}},"click .add-agent"(e,t){e.preventDefault();const a=t.selectedAgents.get();a.forEach(async e=>{const{_id:a,username:n}=e,s=t.departmentAgents.get();if(s.find(e=>{let{agentId:t}=e;return t===a}))return o.error(m("This_agent_was_already_selected"));const i=l.clone(e);i.agentId=a,delete i._id,s.push(i),t.departmentAgents.set(s),t.selectedAgents.set(t.selectedAgents.get().filter(e=>e.username!==n))})},"click button.back"(e){e.preventDefault(),i.go("livechat-departments")},"click .remove-agent"(e,t){e.preventDefault(),t.departmentAgents.set(t.departmentAgents.get().filter(e=>e.agentId!==this.agentId))},"click #addTag"(e,t){e.stopPropagation(),e.preventDefault();const a=[...t.availableTags.get()].length>0,n=a?"#tagSelect":"#tagInput",s=a?"placeholder":"",i=$(n).val(),r=[...t.chatClosingTags.get()];""===i||r.indexOf(i)>-1||(r.push(i),t.chatClosingTags.set(r),$(n).val(s))},"click .remove-tag"(e,t){e.stopPropagation(),e.preventDefault();const a=[...t.chatClosingTags.get()].filter(e=>e!==this.valueOf());t.chatClosingTags.set(a)}}),r.livechatDepartmentForm.onCreated((async function(){this.department=new s({enabled:!0}),this.departmentAgents=new s([]),this.selectedAgents=new s([]),this.tabBar=new c,this.tabBar.showGroup(i.current().route.name),this.tabBarData=new s,this.chatClosingTags=new s([]),this.availableTags=new s([]),this.availableDepartmentTags=new s([]),this.onSelectAgents=e=>{let{item:t}=e;this.selectedAgents.set([t])},this.onClickTagAgents=e=>{let{username:t}=e;this.selectedAgents.set(this.selectedAgents.get().filter(e=>e.username!==t))},this.loadAvailableTags=e=>{n.call("livechat:getTagsList",(t,a)=>{this.availableTags.set(a||[]);const n=this.availableTags.get(),s=n.filter(t=>{let{departments:a}=t;return 0===a.length||a.indexOf(e)>-1}).map(e=>{let{name:t}=e;return t});this.availableDepartmentTags.set(s)})},this.autorun(async()=>{const e=i.getParam("_id");if(e){const{department:t,agents:a=[]}=await u.v1.get("livechat/department/".concat(i.getParam("_id")));this.department.set(t),this.departmentAgents.set(a),this.chatClosingTags.set(t&&t.chatClosingTags||[]),this.loadAvailableTags(e)}})}))}

