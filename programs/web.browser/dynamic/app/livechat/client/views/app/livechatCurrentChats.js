function module(t,e,s){let n,o,a,i,r,c,l,m,g,h,u,d,f,p,v,D,C;s.link("moment-timezone"),s.link("underscore",{default(t){n=t}},0),s.link("moment",{default(t){o=t}},1),s.link("./livechatCurrentChats.css"),s.link("meteor/reactive-var",{ReactiveVar(t){a=t}},2),s.link("meteor/kadira:flow-router",{FlowRouter(t){i=t}},3),s.link("meteor/templating",{Template(t){r=t}},4),s.link("meteor/meteor",{Meteor(t){c=t}},5),s.link("meteor/random",{Random(t){l=t}},6),s.link("toastr",{default(t){m=t}},7),s.link("meteor/rocketchat:tap-i18n",{TAPi18n(t){g=t}},8),s.link("../../../../ui-utils",{modal(t){h=t},call(t){u=t},popover(t){d=t}},9),s.link("../../../../utils/client",{t(t){f=t},handleError(t){p=t},APIClient(t){v=t}},10),s.link("../../../../authorization",{hasRole(t){D=t},hasPermission(t){C=t}},11),s.link("./livechatCurrentChats.html");const k=50,y="Filters.LivechatCurrentChats",F=()=>{let t;try{const e=c._localStorage.getItem(y);t=e?JSON.parse(c._localStorage.getItem(y)):{}}catch(e){t={}}return t},_=t=>{c._localStorage.setItem(y,JSON.stringify(t))},w=()=>{c._localStorage.removeItem(y)};r.livechatCurrentChats.helpers({hasMore(){const t=r.instance();return t.total.get()>t.livechatRooms.get().length},isLoading:()=>r.instance().isLoading.get(),livechatRoom:()=>r.instance().livechatRooms.get(),startedAt(){return o(this.ts).format("L LTS")},lastMessage(){return o(this.lm).format("L LTS")},servedBy(){return this.servedBy&&this.servedBy.username},status(){return this.open?f("Opened"):f("Closed")},isClosed(){return!this.open},onSelectAgents:()=>r.instance().onSelectAgents,agentModifier:()=>(function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const s=t.get();return"@".concat(0===s.length?e:e.replace(new RegExp(t.get()),t=>"<strong>".concat(t,"</strong>")))}),selectedAgents:()=>r.instance().selectedAgents.get(),onClickTagAgent:()=>r.instance().onClickTagAgent,customFilters:()=>r.instance().customFilters.get(),tagFilters:()=>r.instance().tagFilters.get(),tagId(){return this},departmentModifier:()=>(function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const s=t.get();return"".concat(0===s.length?e:e.replace(new RegExp(t.get(),"i"),t=>"<strong>".concat(t,"</strong>")))}),onClickTagDepartment:()=>r.instance().onClickTagDepartment,selectedDepartments:()=>r.instance().selectedDepartments.get(),onSelectDepartments:()=>r.instance().onSelectDepartments,onTableSort(){const{sortDirection:t,sortBy:e}=r.instance();return function(s){if(e.get()===s)return t.set("asc"===t.get()?"desc":"asc");e.set(s),t.set("asc")}},sortBy:t=>r.instance().sortBy.get()===t,sortIcon(t){const{sortDirection:e,sortBy:s}=r.instance();return t===s.get()&&"asc"===e.get()?"sort-up":"sort-down"}}),r.livechatCurrentChats.events({"click .row-link"(){i.go("live",{id:this._id})},"click .js-load-more"(t,e){e.offset.set(e.offset.get()+50)},"click .add-filter-button"(t,e){t.preventDefault();const s=e.customFields.get(),n=e.customFilters.get(),o=e.tagFilters.get(),a=[];a.push({name:f("Tags"),action:()=>{o.push(l.id()),e.tagFilters.set(o)}});for(const r of s)"visible"===r.visibility&&"room"===r.scope&&(n.find(t=>t.name===r._id)||a.push({name:r.label,action:()=>{n.push({_id:r._id,name:r._id,label:r.label}),e.customFilters.set(n)}}));const i={popoverClass:"livechat-current-chats-add-filter",columns:[{groups:[{items:a}]}],currentTarget:t.currentTarget,offsetVertical:t.currentTarget.clientHeight};d.open(i)},"click .livechat-current-chats-extra-actions"(t,e){t.preventDefault(),t.stopPropagation();const{currentTarget:s}=t,n=C("remove-closed-livechat-rooms"),o=()=>{if(D(c.userId(),["admin","livechat-manager"]))return;const t=e.departments.get();return t&&t.map(t=>t._id)},a={popoverClass:"livechat-current-chats-add-filter",columns:[{groups:[{items:[{icon:"customize",name:f("Clear_filters"),action:e.clearFilters},n&&{icon:"trash",name:f("Delete_all_closed_chats"),modifier:"alert",action:()=>{h.open({title:f("Are_you_sure"),type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:f("Yes"),cancelButtonText:f("Cancel"),closeOnConfirm:!0,html:!1},()=>{c.call("livechat:removeAllClosedRooms",o(),(t,s)=>{if(t)return p(t);s&&(e.loadRooms(e.filter.get(),e.offset.get()),m.success(g.__("All_closed_chats_have_been_removed")))})})}}]}]}],currentTarget:s,offsetVertical:s.clientHeight};d.open(a)},"click .remove-livechat-tags-filter"(t,e){t.preventDefault();const{id:s}=t.currentTarget.dataset,n=e.tagFilters.get(),o=n.indexOf(s);o>=0&&n.splice(o,1),e.tagFilters.set(n)},"click .remove-livechat-custom-filter"(t,e){t.preventDefault();const s=t.currentTarget.dataset.name,n=e.customFilters.get(),o=n.findIndex(t=>t.name===s);o>=0&&n.splice(o,1),e.customFilters.set(n)},"submit form"(t,e){t.preventDefault();const s={};$(":input",t.currentTarget).each((function(){if(!this.name)return;const t=$(this).val();return t?this.name.startsWith("custom-field-")?(s.customFields||(s.customFields={}),void(s.customFields[this.name.replace("custom-field-","")]=t)):"tags"===this.name?(s.tags||(s.tags=[]),void(t&&s.tags.push(t))):void(s[this.name]=t):void 0})),n.isEmpty(s.from)?delete s.from:s.from=o(s.from,o.localeData().longDateFormat("L")).toDate(),n.isEmpty(s.to)?delete s.to:s.to=o(s.to,o.localeData().longDateFormat("L")).toDate();const a=e.selectedAgents.get();a&&a.length>0&&(s.agents=[a[0]]);const i=e.selectedDepartments.get();i&&i.length>0&&(s.department=[i[0]]),e.filter.set(s),e.offset.set(0),_(s)},"click .remove-livechat-room"(t,e){t.preventDefault(),t.stopPropagation(),h.open({title:f("Are_you_sure"),type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:f("Yes"),cancelButtonText:f("Cancel"),closeOnConfirm:!1,html:!1},async t=>{t&&(await u("livechat:removeRoom",this._id),e.loadRooms(e.filter.get(),e.offset.get()),h.open({title:f("Deleted"),text:f("Room_has_been_deleted"),type:"success",timer:1e3,showConfirmButton:!1}))})},"input [id=agent]"(t,e){const s=t.currentTarget;""===s.value&&e.selectedAgents.set([])}}),r.livechatCurrentChats.onCreated((async function(){this.isLoading=new a(!1),this.offset=new a(0),this.total=new a(0),this.filter=new a(F()),this.livechatRooms=new a([]),this.selectedAgents=new a([]),this.customFilters=new a([]),this.customFields=new a([]),this.tagFilters=new a([]),this.selectedDepartments=new a([]),this.sortBy=new a("ts"),this.sortDirection=new a("desc"),this.onSelectDepartments=t=>{let{item:e}=t;e.text=e.name,this.selectedDepartments.set([e])},this.onClickTagDepartment=()=>{this.selectedDepartments.set([])};const t=(t,e,s)=>e.reduce((n,o)=>{const a=s===e.length-1;return n+="".concat(t,"[]=").concat(o).concat(a?"":"&")},""),e=(e,s,n)=>{const{status:a,agents:i,department:r,from:c,to:l,tags:m,customFields:g,name:h}=e;let u="livechat/rooms?count=".concat(50,"&offset=").concat(s,"&sort=").concat(JSON.stringify(n));const d={};return a&&(u+="&open=".concat("opened"===a)),r&&Array.isArray(r)&&r.length&&(u+="&departmentId=".concat(r[0]._id)),c&&(d.start="".concat(o(new Date(c)).utc().format("YYYY-MM-DDTHH:mm:ss"),"Z")),l&&(d.end="".concat(o(new Date(l).setHours(23,59,59)).utc().format("YYYY-MM-DDTHH:mm:ss"),"Z")),m&&(u+="&".concat(t("tags",m))),i&&Array.isArray(i)&&i.length&&(u+="&".concat(t("agents",i.map(t=>t._id)))),g&&(u+="&customFields=".concat(JSON.stringify(g))),Object.keys(d).length&&(u+="&createdAt=".concat(JSON.stringify(d))),h&&(u+="&roomName=".concat(h)),u};this.loadDefaultFilters=()=>{const t=this.filter.get();Object.keys(t).forEach(e=>{const s=t[e];if(s){switch(e){case"agents":return this.selectedAgents.set(s);case"department":return this.selectedDepartments.set(s);case"from":case"to":return $("#".concat(e)).datepicker("setDate",new Date(s))}$("#".concat(e)).val(s)}})},this.clearFilters=()=>{w(),$("#form-filters").get(0).reset(),this.selectedAgents.set([]),this.selectedDepartments.set([]),this.filter.set({})},this.loadRooms=async(t,s,n)=>{this.isLoading.set(!0);const{rooms:o,total:a}=await v.v1.get(e(t,s,n));this.total.set(a),0===s?this.livechatRooms.set(o):this.livechatRooms.set(this.livechatRooms.get().concat(o)),this.isLoading.set(!1)},this.onSelectAgents=t=>{let{item:e}=t;this.selectedAgents.set([e])},this.onClickTagAgent=t=>{let{username:e}=t;this.selectedAgents.set(this.selectedAgents.get().filter(t=>t.username!==e))},this.autorun(async()=>{const t=this.filter.get(),e=this.offset.get(),{sortDirection:s,sortBy:n}=r.instance();this.loadRooms(t,e,{[n.get()]:"asc"===s.get()?1:-1})}),c.call("livechat:getCustomFields",(t,e)=>{e&&this.customFields.set(e)}),this.loadDefaultFilters()})),r.livechatCurrentChats.onRendered((function(){this.$(".input-daterange").datepicker({autoclose:!0,todayHighlight:!0,format:o.localeData().longDateFormat("L").toLowerCase()})}))}

