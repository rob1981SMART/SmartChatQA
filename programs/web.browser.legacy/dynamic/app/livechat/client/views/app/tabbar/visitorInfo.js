function module(t,e,n){var i,o,r,s,a,c,u,l,f,d,m,v,h,g,p,w,k,_,C,I,y,B,D;n.link("@babel/runtime/regenerator",{default:function(t){i=t}},0),n.link("meteor/rocketchat:tap-i18n",{TAPi18n:function(t){o=t}},0),n.link("meteor/meteor",{Meteor:function(t){r=t}},1),n.link("meteor/reactive-var",{ReactiveVar:function(t){s=t}},2),n.link("meteor/kadira:flow-router",{FlowRouter:function(t){a=t}},3),n.link("meteor/session",{Session:function(t){c=t}},4),n.link("meteor/templating",{Template:function(t){u=t}},5),n.link("underscore",{default:function(t){l=t}},6),n.link("moment",{default:function(t){f=t}},7),n.link("ua-parser-js",{default:function(t){d=t}},8),n.link("../../../../../ui-utils",{modal:function(t){m=t}},9),n.link("../../../../../models",{Subscriptions:function(t){v=t}},10),n.link("../../../../../settings",{settings:function(t){h=t}},11),n.link("../../../../../utils",{t:function(t){g=t},handleError:function(t){p=t},roomTypes:function(t){w=t}},12),n.link("../../../../../authorization",{hasRole:function(t){k=t},hasPermission:function(t){_=t},hasAtLeastOnePermission:function(t){C=t}},13),n.link("./visitorInfo.html"),n.link("../../../../../utils/client",{APIClient:function(t){I=t}},14),n.link("../../../../../ui-utils/client",{RoomManager:function(t){y=t}},15),n.link("../../../../../lib/client",{DateFormat:function(t){B=t}},16),n.link("../customTemplates/register",{getCustomFormTemplate:function(t){D=t}},17);var b=function(){var t=u.currentData(),e;return!(!t||!t.rid)&&void 0!==v.findOne({rid:t.rid})},R=function(t){return!!h.get("Livechat_request_comment_when_closing_conversation")||t&&t.requestTagBeforeClosingChat};u.visitorInfo.helpers({user:function(){var t=u.instance().user.get();if(t&&t.userAgent){var e=new d;e.setUA(t.userAgent),t.os=e.getOS().name+" "+e.getOS().version,-1!==["Mac OS","iOS"].indexOf(e.getOS().name)?t.osIcon="icon-apple":t.osIcon="icon-"+e.getOS().name.toLowerCase(),t.browser=e.getBrowser().name+" "+e.getBrowser().version,t.browserIcon="icon-"+e.getBrowser().name.toLowerCase(),t.status=w.getUserStatus("l",this.rid)||"offline"}return t},room:function(){return u.instance().room.get()},department:function(){return u.instance().department.get()},joinTags:function(){var t=u.instance().tags.get();return t&&t.join(", ")},customRoomFields:function(){var t=u.instance().customFields.get();if(!t||0===t.length)return[];var e=[],n,i,o=(u.instance().room.get()||{}).livechatData,r=void 0===o?{}:o;return Object.keys(r).forEach((function(n){var i=l.findWhere(t,{_id:n});i&&"hidden"!==i.visibility&&"room"===i.scope&&e.push({label:i.label,value:r[n]})})),e},customVisitorFields:function(){var t=u.instance().customFields.get();if(!t||0===t.length)return[];var e=[],n,i,o=(u.instance().user.get()||{}).livechatData,r=void 0===o?{}:o;return Object.keys(r).forEach((function(n){var i=l.findWhere(t,{_id:n});i&&"hidden"!==i.visibility&&"visitor"===i.scope&&e.push({label:i.label,value:r[n]})})),e},createdAt:function(){return this.createdAt?f(this.createdAt).format("L LTS"):""},lastLogin:function(){return this.lastLogin?f(this.lastLogin).format("L LTS"):""},editing:function(){return"edit"===u.instance().action.get()},forwarding:function(){return"forward"===u.instance().action.get()},editDetails:function(){var t=u.instance(),e=t.user.get();return{visitorId:e?e._id:null,roomId:this.rid,save:function(){t.action.set()},cancel:function(){t.action.set()}}},forwardDetails:function(){var t=u.instance(),e=t.user.get();return{visitorId:e?e._id:null,roomId:this.rid,save:function(){t.action.set()},cancel:function(){t.action.set()}}},roomOpen:function(){var t=u.instance().room.get(),e=r.userId();return t&&t.open&&(t.servedBy&&t.servedBy._id===e||k(e,"livechat-manager"))},canReturnQueue:function(){var t;return u.instance().routingConfig.get().returnQueue},showDetail:function(){if(u.instance().action.get())return"hidden"},canSeeButtons:function(){return!!C(["close-others-livechat-room","transfer-livechat-guest"])||b()},canEditRoom:function(){return!!_("save-others-livechat-room-info")||b()},canCloseRoom:function(){return!!_("close-others-livechat-room")||b()},canForwardGuest:function(){return _("transfer-livechat-guest")},roomClosedDateTime:function(){var t=this.closedAt;return B.formatDateAndTime(t)},roomClosedBy:function(){var t=this.closedBy,e=void 0===t?{}:t,n=this.servedBy,i=void 0===n?{}:n,o=this.closer;if("user"===o){if(i._id!==e._id)return e.username;o="agent"}var r=o.charAt(0).toUpperCase()+o.slice(1);return g(""+r)},customInfoTemplate:function(){return D("livechatVisitorInfo")},roomDataContext:function(){return u.instance().room}}),u.visitorInfo.events({"click .edit-livechat":function(t,e){t.preventDefault(),e.action.set("edit")},"click .close-livechat":function(t,e){if(t.preventDefault(),!R(e.department.get())){var n=o.__("Chat_closed_by_agent");return r.call("livechat:closeRoom",this.rid,n,{clientAction:!0},(function(t){if(t)return p(t);m.open({title:g("Chat_closed"),text:g("Chat_closed_successfully"),type:"success",timer:1e3,showConfirmButton:!1})}))}m.open({title:g("Closing_chat"),modifier:"modal",content:"closeRoom",data:{rid:this.rid},confirmOnEnter:!1,showConfirmButton:!1,showCancelButton:!1})},"click .return-inquiry":function(t){var e=this;t.preventDefault(),m.open({title:g("Would_you_like_to_return_the_inquiry"),type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:g("Yes")},(function(){r.call("livechat:returnAsInquiry",e.rid,(function(t){t?p(t):(c.set("openedRoom"),a.go("/home"))}))}))},"click .forward-livechat":function(t,e){t.preventDefault(),e.action.set("forward")}}),u.visitorInfo.onCreated((function(){var t=this;this.visitorId=new s(null),this.customFields=new s([]),this.action=new s,this.user=new s,this.departmentId=new s(null),this.tags=new s(null),this.routingConfig=new s({}),this.department=new s({}),this.room=new s({}),this.updateVisitor=function(){function e(e){var n,o;return i.async(function(){function r(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,i.awrap(I.v1.get("livechat/visitors.info?visitorId="+e));case 2:n=r.sent,o=n.visitor,t.user.set(o);case 5:case"end":return r.stop()}}return r}())}return e}(),this.updateRoom=function(e){t.departmentId.set(e&&e.departmentId),t.tags.set(e&&e.tags),t.room.set(e);var n=e&&e.v&&e.v._id;t.visitorId.set(n),t.updateVisitor(n)},r.call("livechat:getCustomFields",(function(e,n){n&&t.customFields.set(n)}));var e,n=u.currentData().rid;r.call("livechat:getRoutingConfig",(function(e,n){n&&t.routingConfig.set(n)}));var o=function(){function e(e){var n,o;return i.async(function(){function r(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,i.awrap(I.v1.get("rooms.info?roomId="+e));case 2:n=r.sent,o=n.room,t.updateRoom(o);case 5:case"end":return r.stop()}}return r}())}return e}();n&&(y.roomStream.on(n,this.updateRoom),o(n)),this.autorun(function(){function e(){var e,n;return i.async(function(){function o(o){for(;;)switch(o.prev=o.next){case 0:if(!t.departmentId.get()){o.next=6;break}return o.next=3,i.awrap(I.v1.get("livechat/department/"+t.departmentId.get()+"?includeAgents=false"));case 3:e=o.sent,n=e.department,t.department.set(n);case 6:case"end":return o.stop()}}return o}())}return e}()),this.autorun((function(){var e=t.visitorId.get();e&&t.updateVisitor(e)}))})),u.visitorInfo.onDestroyed((function(){var t,e=u.currentData().rid;y.roomStream.removeListener(e,this.updateRoom)}))}

